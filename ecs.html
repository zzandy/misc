<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml">

<head>
    <meta charset="utf-8" />
    <title>ECS</title>
</head>

<body>
    <script name="canvas" type="text/javascript">

        // canvas w/ hex
        function fullscreenCanvas() {
            let [can, ctx] = makeCanvas(window.innerWidth, window.innerHeight, false)

            document.body.appendChild(can);
            document.body.style.overflow = "hidden";
            document.body.style.margin = "0";
            document.body.style.padding = "0";

            return ctx;
        }

        function makeCanvas(width, height, alpha) {

            let can = document.createElement('canvas');
            let ctx = can.getContext('2d', { alpha });

            ctx.canvas.width = width;
            ctx.canvas.height = height;
            ctx.canvas.style.display = 'block';

            return [can, ctx];
        }
    </script>

    <script name="loop" type="text/javascript">

        function loop(fps, update, render) {

            let then = performance.now();
            let fixedDelta = 1000 / fps;
            let acc = fixedDelta;

            function tick() {
                let now = performance.now();
                acc += now - then;
                then = now;

                let doRender = false;
                let retry = 20;
                while (acc >= fixedDelta && retry-- > 0) {
                    doRender = true;
                    acc -= fixedDelta;
                    update(fixedDelta);
                }

                if (acc > fixedDelta) {
                    acc = fixedDelta;
                }

                if (doRender) {
                    requestAnimationFrame(render)
                }

                setTimeout(tick, fixedDelta);
            }

            tick();
        }

    </script>

    <script name="lib" type="text/javascript">
        function rnd(n) {
            return (Math.random() * n) | 0;
        }
    </script>

    <script type="text/javascript">
        const tau = Math.PI;
        const deg = tau / 360;
        const rad = 1 / deg;

        const ctx = fullscreenCanvas();

        const { width, height } = ctx.canvas;

        const systems = [];

        function addEntity(...components) {
            const entity = Object.fromEntries(components);

            for (const system of systems) {
                if (system.components.every(component => component in entity)) {
                    system.add(entity);
                }
            }
        }

        function addSystem(pool, process, ...components) {
            const entities = []

            const system = {
                entities,
                run: (delta) => { for (const e of entities) process(e, delta) },
                components: components.map(c => c.component),
                add: (e) => entities.push(e)
            }

            systems.push(system)
            pool.push(system)
        }

        function addComponent(name) {
            const gen = (value) => {
                return [name, value];
            }

            gen.component = name;
            return gen;
        }

        const locatable = addComponent('locatable');
        const roamable = addComponent('roamable');
        const renderable = addComponent('renderable');

        // system pools
        const fixed = [];
        const variable = [];

        addSystem(fixed, ({ locatable, roamable }, delta) => {

            const d = roamable.velocity * delta;
            roamable.angle += (rnd(1000) - 500) / 100000;

            locatable.x += d * Math.cos(roamable.angle * rad);
            locatable.y += d * Math.sin(roamable.angle * rad);

        }, roamable, locatable);

        addSystem(variable, (entity) => {
            entity.renderable(entity);
        }, locatable, renderable);

        for(let i=0;i<100;++i)
        addEntity(locatable({ x: width / 2, y: height / 2 }), roamable({ angle: rnd(360), velocity: .1 }), renderable(renderBall));

        function renderBall({ locatable, roamable }) {
            ctx.strokeStyle=            ctx.fillStyle = 'silver';
            ctx.fillRect(locatable.x-5, locatable.y-5, 10, 10);
            ctx.beginPath();
            ctx.moveTo(locatable.x, locatable.y);
            ctx.lineTo(locatable.x + 200*roamable.velocity * Math.cos(roamable.angle * rad), locatable.y +200* roamable.velocity * Math.sin(roamable.angle * rad))
            ctx.stroke();
        }

        function update(delta) {
            for (const system of fixed) {
                system.run(delta);
            }
        }

        function render() {
            ctx.clearRect(0, 0, width, height);

            for (const system of variable) {
                system.run();
            }
        }

        loop(60, update, render);
    </script>
</body>

</html>