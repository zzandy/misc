<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml">

<head>
    <meta charset="utf-8" />
    <title>Traveling</title>
</head>

<body>
    <script name="canvas" type="text/javascript">

        // canvas w/ hex
        function fullscreenCanvas() {
            let [can, ctx] = makeCanvas(window.innerWidth, window.innerHeight, false)

            document.body.appendChild(can);
            document.body.style.overflow = "hidden";
            document.body.style.margin = "0";
            document.body.style.padding = "0";

            return ctx;
        }

        function makeCanvas(width, height, alpha) {

            let can = document.createElement('canvas');
            let ctx = can.getContext('2d', { alpha });

            ctx.canvas.width = width;
            ctx.canvas.height = height;
            ctx.canvas.style.display = 'block';

            return [can, ctx];
        }
    </script>

    <script name="loop" type="text/javascript">

        function loop(targetFps, fixedUpdate, render) {
            let fixedDelta = 1000 / targetFps;
            let acc = fixedDelta;
            let then = performance.now();

            function tick(now) {
                let delta = now - then;
                acc += delta;
                then = now;
                let doRender = acc >= fixedDelta;
                let reps = 0;

                while (acc >= fixedDelta && ++reps < 20) {
                    acc -= fixedDelta;
                    fixedUpdate(fixedDelta);
                }

                if (reps == 20) acc = 0;

                if (doRender)
                    render(delta);

                requestAnimationFrame(tick);
            }

            tick(then);
        }
    </script>

    <script type="text/javascript">

        let ctx = fullscreenCanvas();
        let w = ctx.canvas.width;
        let h = ctx.canvas.height;

        let path = makePoints(20, w, h);
        let best = [...path];
        let bestLength = measure(best);
        console.log(bestLength)

        let s = ((h / 150) / 2 | 0) * 2;

        loop(60, update, render);

        function update() {
            path = [...best];

            let n = 1 + (Math.random() < .2 ? 1 : 0) + (Math.random() < .1 ? 1 : 0) + (Math.random() < .05 ? 1 : 0);

            for (let k = 0; k < n; ++k) {
                let i = rnd(path.length) | 0;
                let j = rnd(path.length) | 0;

                while (i == j)
                    j = rnd(path.length) | 0;

                let t = path[i];
                path[i] = path[j];
                path[j] = t;
            }

            let len = measure(path);

            if (len < bestLength) {
                best = path;

                bestLength = len;
                console.log(len)
            }
        }

        function render() {
            ctx.clearRect(0, 0, w, h);


            ctx.lineWidth = ctx.lineWidth * 2
            ctx.strokeStyle = 'gold';
            ctx.fillStyle = 'yellow';
            drawPath(best);

            ctx.lineWidth = ctx.lineWidth / 2
            ctx.strokeStyle = 'grey';
            ctx.fillStyle = 'silver';
            drawPath(path);

            prev = null;
            for (let point of path) {
                if (prev != null) {
                    ctx.beginPath();
                    ctx.moveTo(prev[0], prev[1]);
                    ctx.lineTo(point[0], point[1]);
                    ctx.stroke();
                }
                prev = point;
                ctx.fillRect(point[0] - s / 2, point[1] - s / 2, s, s);
            }
        }

        function drawPath(path) {
            prev = null;
            for (let point of path) {
                if (prev != null) {
                    ctx.beginPath();
                    ctx.moveTo(prev[0], prev[1]);
                    ctx.lineTo(point[0], point[1]);
                    ctx.stroke();
                }
                prev = point;
                ctx.fillRect(point[0] - s / 2, point[1] - s / 2, s, s);
            }
        }

        function makePoints(n, w, h) {
            let pad = Math.min(w * .5, h * .05);

            let points = [];
            for (let i = 0; i < n; ++i)
                points.push([(pad + rnd(w - pad * 2)) | 0, (pad + rnd(h - pad * 2)) | 0])

            return points;
        }

        function rnd(n) {
            return (Math.random() * n)
        }

        function measure(path) {
            let res = 0;
            for (let i = 1; i < path.length; ++i) {
                let dx = path[i][0] - path[i - 1][0];
                let dy = path[i][1] - path[i - 1][1];

                res += dx * dx + dy * dy;
            }
            return res;
        }

    </script>
</body>

</html>